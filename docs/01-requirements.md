# 要件定義書 - MiniSlack

## 1. プロジェクト概要

### 1.1 目的
Java、Spring Boot、オニオンアーキテクチャを学習するための実践的なチャットアプリケーション「MiniSlack」を開発します。

### 1.2 対象ユーザー
- Javaを学習中の開発者
- オニオンアーキテクチャ（Clean Architecture）を理解したい開発者
- Spring Bootの実践的な使い方を学びたい開発者

### 1.3 スコープ
本プロジェクトは学習目的のため、実運用レベルのセキュリティや高可用性は実装しません。基本的な機能とアーキテクチャの理解に焦点を当てます。

---

## 2. 機能要件

### 2.1 ユーザー管理機能

#### 2.1.1 ユーザー登録
- **概要**: 新規ユーザーがアカウントを作成できる
- **入力項目**:
  - ユーザー名（必須、3-20文字、英数字とアンダースコアのみ）
  - メールアドレス（必須、有効なメール形式）
  - パスワード（必須、8文字以上）
  - 表示名（必須、1-50文字）
- **処理**:
  - ユーザー名とメールアドレスの重複チェック
  - パスワードのハッシュ化（BCrypt）
  - ユーザーIDの自動採番(UUIDv4)
  - 作成日時の記録
- **出力**: ユーザーID、登録完了メッセージ

#### 2.1.2 ユーザー認証
- **概要**: 登録済みユーザーがログインできる
- **入力項目**:
  - メールアドレスまたはユーザー名
  - パスワード
- **処理**:
  - 認証情報の検証
  - JWTトークンの発行
- **出力**: アクセストークン、ユーザー情報

#### 2.1.3 ユーザー情報取得
- **概要**: 自分または他のユーザーの基本情報を取得できる
- **入力項目**: ユーザーID
- **処理**: ユーザー情報の取得（パスワードを除く）
- **出力**: ユーザーID、ユーザー名、表示名、作成日時

### 2.2 チャンネル管理機能

#### 2.2.1 チャンネル作成
- **概要**: 認証済みユーザーがチャンネルを作成できる
- **入力項目**:
  - チャンネル名（必須、4-50文字）
  - 説明（任意、500文字以内）
  - 公開/非公開フラグ（デフォルト：公開）
- **処理**:
  - チャンネル名の重複チェック
  - チャンネルIDの自動採番
  - 作成者を自動的にメンバーとして追加
- **出力**: チャンネルID、チャンネル情報

#### 2.2.2 チャンネル一覧取得
- **概要**: 参加可能なチャンネル一覧を取得できる
- **入力項目**: なし（認証情報から判断）
- **処理**:
  - 公開チャンネル全て
  - 自分が参加している非公開チャンネル
  - ページネーション対応（1ページ20件）
- **出力**: チャンネル一覧（ID、名前、説明、メンバー数）

#### 2.2.3 チャンネル参加
- **概要**: ユーザーが公開チャンネルに参加できる
- **入力項目**: チャンネルID
- **処理**:
  - チャンネルの公開状態確認
  - 既に参加済みでないかチェック
  - メンバーシップの作成
- **出力**: 参加完了メッセージ

#### 2.2.4 チャンネル退出
- **概要**: ユーザーがチャンネルから退出できる
- **入力項目**: チャンネルID
- **処理**:
  - 参加中であることの確認
  - メンバーシップの削除
- **出力**: 退出完了メッセージ

### 2.3 メッセージ機能

#### 2.3.1 メッセージ送信（REST API）
- **概要**: チャンネルメンバーがメッセージを送信できる
- **入力項目**:
  - チャンネルID
  - メッセージ本文（必須、1-2000文字）
- **処理**:
  - チャンネルメンバーシップの確認
  - メッセージIDの自動採番
  - 送信日時の記録
  - RabbitMQへのイベント発行（リアルタイム通知用）
- **出力**: メッセージID、送信完了メッセージ

#### 2.3.2 メッセージ取得
- **概要**: チャンネルのメッセージ履歴を取得できる
- **入力項目**:
  - チャンネルID
  - ページ番号（オプション）
  - 1ページあたりの件数（オプション、デフォルト50件）
- **処理**:
  - チャンネルメンバーシップの確認
  - メッセージの取得（新しい順）
  - ページネーション
- **出力**: メッセージ一覧（ID、送信者、本文、送信日時）

#### 2.3.3 メッセージ検索
- **概要**: メッセージをキーワードで検索できる
- **入力項目**:
  - 検索キーワード
  - チャンネルID（オプション）
- **処理**:
  - 参加中のチャンネルのメッセージのみ検索
  - 全文検索
- **出力**: マッチしたメッセージ一覧

### 2.4 リアルタイム通知機能（RabbitMQ）

#### 2.4.1 新規メッセージ通知
- **概要**: メッセージ送信時に参加メンバーへリアルタイム通知
- **処理フロー**:
  1. メッセージ送信API呼び出し
  2. メッセージをDBに保存
  3. RabbitMQに「新規メッセージ」イベントをPublish
  4. 通知サービスがイベントをSubscribe
  5. チャンネルメンバー全員に通知を送信（WebSocket/SSE/Polling）
- **イベントペイロード**:
  - メッセージID
  - チャンネルID
  - 送信者ID
  - メッセージ本文
  - 送信日時

#### 2.4.2 チャンネル更新通知
- **概要**: チャンネル情報変更時の通知
- **トリガー**:
  - 新規メンバー追加
  - メンバー退出
- **イベントペイロード**:
  - チャンネルID
  - イベント種別
  - 対象ユーザーID

### 2.5 バッチ処理機能

#### 2.5.1 古いメッセージのアーカイブ
- **概要**: 90日以上前のメッセージをアーカイブテーブルに移動
- **実行タイミング**: 毎日深夜2時（Cron）
- **処理内容**:
  1. 90日以上前のメッセージを抽出
  2. アーカイブテーブルにコピー
  3. 元のテーブルから削除
  4. 処理結果のログ出力
- **エラーハンドリング**: 失敗時はリトライ（最大3回）

#### 2.5.2 統計情報集計
- **概要**: チャンネルとユーザーの活動統計を集計
- **実行タイミング**: 毎日深夜3時（Cron）
- **集計内容**:
  - チャンネル別メッセージ数（日次）
  - ユーザー別投稿数（日次）
  - アクティブユーザー数
- **出力**: 統計テーブルへの保存

### 2.6 Web UI機能

#### 2.6.1 ログイン画面
- ログインフォーム
- エラーメッセージ表示

#### 2.6.2 チャンネル一覧画面
- サイドバー: 参加チャンネル一覧
- チャンネル作成ボタン
- チャンネル検索

#### 2.6.3 チャット画面
- メッセージ一覧表示
- メッセージ入力フォーム
- 自動スクロール（新規メッセージ受信時）
- メンバー一覧表示

---

## 3. 非機能要件

### 3.1 パフォーマンス

#### 3.1.1 応答時間
- API応答時間: 95パーセンタイルで500ms以内
- メッセージ取得: 100ms以内（50件取得時）
- リアルタイム通知遅延: 1秒以内

#### 3.1.2 スループット
- 同時接続ユーザー数: 100ユーザー（学習用として）
- メッセージ送信: 10件/秒

### 3.2 セキュリティ

#### 3.2.1 認証・認可
- JWT（JSON Web Token）による認証
- トークン有効期限: 24時間
- パスワードハッシュ化: BCrypt（ストレングス10）

#### 3.2.2 入力検証
- 全ての入力値のバリデーション
- SQLインジェクション対策（PreparedStatement使用）
- XSS対策（エスケープ処理）

#### 3.2.3 HTTPS
- 学習用のため、ローカル環境ではHTTPも許可
- 本番環境を想定した設定例を提供

### 3.3 可用性

#### 3.3.1 エラーハンドリング
- 全てのAPIで適切なHTTPステータスコード返却
- エラーメッセージの統一フォーマット
- 例外の適切なログ出力

#### 3.3.2 データ整合性
- トランザクション管理
- 楽観的ロック（バージョン管理）

### 3.4 保守性

#### 3.4.1 ログ出力
- レベル別ログ（ERROR、WARN、INFO、DEBUG）
- リクエストID付与（トレーサビリティ）
- JSON形式のログ出力

#### 3.4.2 監視
- ヘルスチェックエンドポイント（/actuator/health）
- メトリクス収集（/actuator/metrics）

### 3.5 スケーラビリティ

#### 3.5.1 データベース
- インデックス設定（頻繁に検索されるカラム）
- ページネーション実装

#### 3.5.2 メッセージキュー
- RabbitMQによる非同期処理
- スケールアウト可能な設計

### 3.6 開発環境

#### 3.6.1 実行環境
- Java 17（LTS）
- Spring Boot 3.4
- Docker & Docker Compose

#### 3.6.2 データベース
- PostgreSQL 16
- 開発環境: Dockerコンテナ
- テスト環境: H2 Database（In-Memory）

#### 3.6.3 メッセージブローカー
- RabbitMQ 3.12
- 開発環境: Dockerコンテナ

---

## 4. 制約事項

### 4.1 技術的制約
- Java 17以降が必要
- Dockerがインストールされていること
- 8080ポート（Spring Boot）、5432ポート（PostgreSQL）、5672/15672ポート（RabbitMQ）が利用可能であること

### 4.2 機能的制約
- ファイル添付機能は実装しない（学習スコープ外）
- ビデオ/音声通話機能は実装しない
- プライベートメッセージ（DM）は実装しない
- スレッド機能は実装しない
- リアクション機能は実装しない

### 4.3 運用的制約
- 本番運用は想定しない（学習用途のみ）
- データバックアップ機能は最小限
- 高可用性構成は考慮しない

---

## 5. データモデル概要

### 5.1 主要エンティティ

#### User（ユーザー）
- userId (PK)
- username
- email
- passwordHash
- displayName
- createdAt
- updatedAt

#### Channel（チャンネル）
- channelId (PK)
- channelName
- description
- isPublic
- createdBy (FK -> User)
- createdAt
- updatedAt

#### ChannelMembership（チャンネルメンバーシップ）
- membershipId (PK)
- channelId (FK -> Channel)
- userId (FK -> User)
- joinedAt

#### Message（メッセージ）
- messageId (PK)
- channelId (FK -> Channel)
- userId (FK -> User)
- content
- createdAt

#### MessageArchive（メッセージアーカイブ）
- archiveId (PK)
- messageId
- channelId
- userId
- content
- createdAt
- archivedAt

#### ActivityStats（活動統計）
- statsId (PK)
- targetDate
- channelId (nullable)
- userId (nullable)
- messageCount
- activeUserCount
- createdAt

---

## 6. API設計概要

### 6.1 認証API
- POST /api/v1/auth/register - ユーザー登録
- POST /api/v1/auth/login - ログイン
- POST /api/v1/auth/logout - ログアウト
- GET /api/v1/auth/me - 現在のユーザー情報取得

### 6.2 ユーザーAPI
- GET /api/v1/users/{userId} - ユーザー情報取得
- GET /api/v1/users - ユーザー一覧取得

### 6.3 チャンネルAPI
- POST /api/v1/channels - チャンネル作成
- GET /api/v1/channels - チャンネル一覧取得
- GET /api/v1/channels/{channelId} - チャンネル詳細取得
- POST /api/v1/channels/{channelId}/join - チャンネル参加
- POST /api/v1/channels/{channelId}/leave - チャンネル退出
- GET /api/v1/channels/{channelId}/members - メンバー一覧取得

### 6.4 メッセージAPI
- POST /api/v1/channels/{channelId}/messages - メッセージ送信
- GET /api/v1/channels/{channelId}/messages - メッセージ取得
- GET /api/v1/messages/search - メッセージ検索

### 6.5 監視API
- GET /actuator/health - ヘルスチェック
- GET /actuator/metrics - メトリクス

---

## 7. 学習目標

本プロジェクトを通じて以下を習得できます：

### 7.1 オニオンアーキテクチャ
- ドメイン駆動設計（DDD）の基礎
- レイヤー分離と依存性の方向
- ビジネスロジックの独立性

### 7.2 Spring Boot
- 依存性注入（DI）とIoC
- Spring Data JPA
- Spring Security（JWT認証）
- Spring AMQP（RabbitMQ）
- Spring Batch

### 7.3 REST API設計
- RESTful原則
- HTTPメソッドとステータスコード
- エラーハンドリング

### 7.4 非同期処理
- メッセージキュー（RabbitMQ）
- イベント駆動アーキテクチャ
- Publisher/Subscriberパターン

### 7.5 バッチ処理
- Spring Batchの基礎
- ジョブスケジューリング
- チャンク指向処理

### 7.6 テスト
- 単体テスト（JUnit 5）
- 統合テスト
- モックとスタブ（Mockito）

---

## 8. 次のステップ

要件定義が完了しました。次は以下のドキュメントに進みます：

1. **オニオンアーキテクチャ概要** (`02-architecture-overview.md`)
   - アーキテクチャの詳細説明
   - レイヤー構造
   - 依存性ルール

2. **ドメインモデル設計** (`03-domain-model.md`)
   - ドメインエンティティの詳細
   - 集約（Aggregate）の設計
   - ビジネスルール

3. **環境構築** (`04-environment-setup.md`)
   - 開発環境のセットアップ手順

